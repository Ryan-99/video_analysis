# 抖音账号分析Web产品 - 产品需求文档 (PRD)

> **文档版本**: v1.1
> **创建日期**: 2025-01-20
> **最后更新**: 2025-01-20
> **更新内容**: MVP架构调整 - 混合部署方案（Vercel + Railway），无需用户认证

---

## 一、项目概述

### 1.1 产品定位
一个基于代码+AI混合模式的抖音账号数据分析工具，将现有的6个Prompt工作流程转化为Web产品，用于自动分析抖音账号数据并生成完整的分析报告。

### 1.2 目标用户
- 自己使用/团队内部工具（MVP阶段，无需用户认证）
- 需要批量分析抖音账号数据的运营人员

### 1.3 核心价值
- 自动化数据计算：用代码固化P90、MAD、阈值法等确定性计算
- 智能化内容分析：用AI完成账号概况、阶段划分、爆款机制抽象、选题库生成
- 标准化报告输出：一键生成Word/Excel/PNG格式的完整分析报告

---

## 二、功能需求

### 2.1 MVP阶段核心功能

#### 功能1：文件上传与解析
**用户流程**：上传Excel/CSV → 系统解析 → 预览确认

| 功能点 | 描述 |
|--------|------|
| 文件格式支持 | Excel (.xlsx, .xls)、CSV |
| 文件大小限制 | 10MB |
| 列名智能识别 | 自动识别点赞/评论/收藏/转发/发布时间/标题列 |
| 数据清洗 | 空值处理、格式转换、异常值检测 |
| 数据验证 | 必要字段检查、数据量验证 |
| 预览展示 | 显示前5条数据供用户确认 |

#### 功能2：数据分析与计算
**代码负责**（确定性计算）：

| 计算项 | 公式/逻辑 |
|--------|----------|
| 互动总量 | 点赞 + 评论 + 收藏 + 转发 |
| 收藏率 | 收藏 / 互动总量 × 100 |
| 收藏/点赞比 | 收藏率 / 点赞数 × 100 |
| P90 | 90分位数 |
| 中位数 | Median |
| MAD | median(\|x - median(x)\|) |
| 当月阈值 | max(当月P90, 当月中位数 + 3×MAD) |
| 爆款判定 | 单条视频互动总量 ≥ 当月阈值 |

**AI负责**（智能分析）：

| 分析项 | 输入 | 输出 |
|--------|------|------|
| 账号概况分析 | 视频标题、互动数据 | 账号类型、受众画像、核心母题、变现链路 |
| 阶段划分 | 月度趋势数据、爆款数据 | 起号期/爆发期/成熟期 + 解释 |
| 爆款分类 | 爆款标题列表 | 按类型分组 + 统计指标 |
| 母题抽象 | 爆款内容 | 高频场景+隐秘规则+反常识公式 |
| 方法论提取 | 爆款样本 | 选题公式、标题公式、脚本公式 |
| 选题库生成 | 母题+公式 | 30条完整选题（标题+口播稿+分镜） |

#### 功能3：图表生成
使用Python后端生成PNG图片：

| 图表类型 | 描述 |
|----------|------|
| 月度趋势折线图 | x=月份，y=当月平均互动总量 |
| 全周期爆点折线图 | x=日期，y=当天Top1互动量，标注月度Top1 |
| 爆款分类统计图 | 柱状图/饼图展示各类爆款数量和表现 |

#### 功能4：报告生成与导出
支持多种格式导出：

| 格式 | 内容 |
|------|------|
| 在线预览 | 网页查看完整报告，交互式图表 |
| Word文档 | .docx格式，包含所有章节、表格、图片 |
| Excel源文件 | .xlsx格式，多Sheet（趋势数据/原始数据/爆款清单/选题库） |
| PNG图片 | 单独下载图表文件 |

### 2.2 报告章节结构（完整版）

```
一、账号概况
- 账号昵称、粉丝数、账号类型、内容形态
- 数据时间范围、总视频数量、发布频率
- 最佳发布时间、核心受众人群、核心母题
- 变现方式（5层结构）

二、月度平均综合表现趋势拆解
- 小总结
- 月度趋势折线图
- 数据分析口径说明
- 阶段划分（起号期/调整期/爆发期/成熟期）
- 关键波峰分析
- 爆发期细化（4-6个爆发期，每个含Top10典型视频）

三、全周期每日爆款视频拆解（阈值法）
- 小总结
- 全周期每日爆点折线图
- 数据分析口径说明（P90/MAD通俗解释）
- 爆款分类统计
- 爆款发布时间分布
- 方法论抽象（母题公式/选题公式/标题公式/脚本公式）
- 爆款选题库（聚合表）

四、30条可直接拍的爆款选题库
- 分组目录（6大类，每类5条）
- 每条包含：选题四要素、3个标题备选、60秒口播稿、案例点位、6镜头分镜

附录：字段映射与验证
```

---

## 三、技术架构

### 3.1 技术栈选型

| 层级 | 技术选择 | 理由 |
|------|----------|------|
| 前端 | Next.js 14 + TypeScript + TailwindCSS | Vercel原生支持，全栈能力 |
| UI组件 | shadcn/ui | 快速构建，样式现代 |
| 后端 | Next.js API Routes (Serverless) | 前后端统一，部署简单 |
| 数据库 | SQLite + Prisma | Vercel支持本地文件数据库，MVP无需云数据库 |
| 文件存储 | Vercel Blob | 对象存储，CDN加速 |
| AI服务 | Claude（优先）+ OpenAI（备用） | 多供应商支持，降本增效 |
| 图表生成 | Python (FastAPI + Matplotlib) | 独立部署，避免Vercel超时 |
| Word生成 | docx (Node.js库) | 服务端生成Word |
| Excel生成 | exceljs | 多Sheet，图表嵌入 |

### 3.2 MVP关键架构决策

**1. 无用户认证系统**
- MVP阶段作为单用户/团队内部工具
- 简化开发流程，快速交付核心功能
- 后续版本可扩展用户系统

**2. 混合部署方案**
- **Vercel**: 前端 + 短时API（上传、解析、状态查询）
- **Railway**: Python图表生成服务（避免Vercel 10秒超时限制）

**3. 内存任务队列**
- MVP使用内存队列存储任务状态
- 生产环境可升级为Redis/BullMQ

**4. 异步任务处理**
- 前端轮询查询任务进度（每2秒）
- 任务状态：queued → parsing → calculating → analyzing → generating_charts → completed/failed

### 3.3 系统架构图

```
┌─────────────────────────────────────────────────────────────┐
│                        用户层                                 │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ 文件上传界面 │  │ 分析进度界面 │  │ 报告预览界面 │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
                            ↓ HTTPS
┌─────────────────────────────────────────────────────────────┐
│                    应用层 (Vercel)                           │
│  ┌──────────────────────────────────────────────────────┐   │
│  │              Next.js App Router                      │   │
│  │  ┌────────────────────────────────────────────┐     │   │
│  │  │ /app/api/upload/route.ts                   │     │   │
│  │  │ /app/api/analyze/route.ts                  │     │   │
│  │  │ /app/api/report/route.ts                   │     │   │
│  │  └────────────────────────────────────────────┘     │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
         ↓                           ↓
┌──────────────────────┐  ┌──────────────────────────────────┐
│   计算层 (代码)      │  │   分析层 (AI)                     │
│  - 文件解析          │  │  - 账号概况分析                   │
│  - 数据清洗          │  │  - 阶段划分分析                   │
│  - 指标计算          │  │  - 爆款机制抽象                   │
│  - P90/MAD/阈值      │  │  - 选题库生成                     │
│  - 图表生成          │  │  - 方法论提取                     │
│  - 报告组装          │  │                                   │
└──────────────────────┘  └──────────────────────────────────┘
         ↓                           ↓
┌─────────────────────────────────────────────────────────────┐
│                        数据层                                 │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ PostgreSQL   │  │ Vercel Blob  │  │ Redis Cache  │      │
│  │ (用户/任务)  │  │ (文件存储)   │  │ (任务队列)   │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
```

### 3.4 数据流程图

```
用户上传Excel/CSV
    ↓
前端验证（格式、大小）
    ↓
上传到Vercel Blob
    ↓
后端解析文件 → 列名识别 → 数据清洗 → 数据验证
    ↓
用户确认列映射
    ↓
创建分析任务 → 返回任务ID
    ↓
【并行处理两路任务】
    ↓                      ↓
┌────────────┐      ┌────────────┐
│ 计算任务流  │      │ AI分析流    │
│ (代码执行)  │      │ (异步调用)   │
│            │      │            │
│ - 基础指标  │      │ - 账号概况  │
│ - 月度统计  │      │ - 阶段划分  │
│ - P90/MAD  │      │ - 爆款分类  │
│ - 阈值计算  │      │ - 母题抽象  │
│ - 爆款筛选  │      │ - 方法论    │
└────────────┘      └────────────┘
    ↓                      ↓
    └──────────┬──────────┘
               ↓
        调用Python图表服务（Railway）
               ↓
        生成PNG图表
               ↓
    ┌────────────────────┐
    │   生成最终报告      │
    │  - Word文档         │
    │  - Excel源文件      │
    │  - PNG图表          │
    └────────────────────┘
               ↓
        更新任务状态为完成
               ↓
        前端轮询检测到完成
               ↓
        用户下载/预览报告
```

---

## 四、数据库设计

### 4.1 数据库选型
MVP阶段使用 **SQLite + Prisma**，原因：
- Vercel支持本地文件数据库
- 无需额外部署云数据库
- 满足MVP单用户场景需求
- 后续可平滑迁移到PostgreSQL

### 4.2 Prisma Schema（MVP简化版）

详细数据库设计请参见 [database-schema.md](./database-schema.md)

---

## 五、API设计

### 5.1 MVP核心API端点（精简版）

| 端点 | 方法 | 超时 | 描述 |
|------|------|------|------|
| `/api/upload` | POST | 10s | 上传文件到Blob |
| `/api/parse` | POST | 10s | 解析文件，返回预览 |
| `/api/analyze` | POST | 异步 | 创建分析任务 |
| `/api/tasks/:id` | GET | 1s | 查询任务状态 |
| `/api/report/:id` | GET | 1s | 获取报告数据 |
| `/api/report/:id/download` | GET | 1s | 下载报告文件 |

详细API设计请参见 [api-design.md](./api-design.md)

---

## 六、部署方案

### 6.1 混合部署架构

| 服务 | 平台 | 说明 |
|------|------|------|
| 前端应用 | Vercel | Next.js静态导出 + Serverless Functions |
| 短时API | Vercel | 上传、解析、状态查询（<10秒） |
| 图表生成服务 | Railway | Python FastAPI服务，避免Vercel超时 |
| 文件存储 | Vercel Blob | 上传文件、生成的报告文件 |
| 数据库 | SQLite | Vercel本地文件数据库 |

### 6.2 环境变量配置

**Vercel环境变量：**
```bash
# AI服务
CLAUDE_API_KEY=xxx
OPENAI_API_KEY=xxx

# 文件存储
BLOB_READ_WRITE_TOKEN=xxx

# Python服务URL
PYTHON_CHART_SERVICE_URL=https://xxx.railway.app
```

**Railway环境变量：**
```bash
# 无需额外配置，仅运行Python图表生成服务
```

---

## 七、代码与AI分工明细

### 7.1 代码负责（可固化）

| 模块 | 功能 | 技术实现 |
|------|------|----------|
| 文件解析 | Excel/CSV读取、列名识别 | xlsx, papaparse |
| 数据清洗 | 空值处理、格式转换、异常值检测 | 手写逻辑 |
| 数据验证 | 字段完整性、数值合理性 | 手写逻辑 |
| 基础计算 | 互动总量、收藏率、收藏/点赞比 | JavaScript |
| 月度统计 | 按月分组、计算平均值 | lodash.groupby |
| P90计算 | 90分位数 | simple-statistics |
| 中位数计算 | Median | simple-statistics |
| MAD计算 | median(\|x - median(x)\|) | 自实现 |
| 阈值计算 | max(P90, median + 3×MAD) | JavaScript |
| 爆款筛选 | 互动总量 ≥ 当月阈值 | JavaScript筛选 |
| 图表生成 | 折线图、柱状图 | Python matplotlib |
| PNG导出 | 图片文件生成 | canvas-node |
| Excel生成 | 多Sheet、图表嵌入 | exceljs |
| Word生成 | 文档结构、表格、图片 | docx |

### 7.2 AI负责（需智能判断）

| 模块 | 输入 | 输出 | 推荐模型 |
|------|------|------|----------|
| 账号概况分析 | 视频标题列表、互动数据 | 账号类型、受众画像、核心母题、变现链路 | Claude（优先） |
| 阶段划分 | 月度趋势数据、爆款数据 | 起号期/爆发期/成熟期 + 解释 | Claude（优先） |
| 爆款分类 | 爆款标题列表 | 按类型分组 + 统计指标 | Claude（优先） |
| 母题抽象 | 爆款内容 | 高频场景+隐秘规则+反常识公式 | Claude（优先） |
| 选题公式 | 爆款样本 | 选题公式、标题公式、脚本公式 | Claude（优先） |
| 选题库生成 | 母题+公式 | 30条完整选题 | Claude（优先） |

**AI服务切换策略：**
- 优先使用Claude API（国内访问稳定）
- 失败时自动切换到OpenAI
- 重试3次后仍失败则报错

---

## 八、核心文件清单

实现此产品需要开发的核心文件：

### 8.1 后端核心文件

| 文件路径 | 功能描述 |
|----------|----------|
| `/src/app/api/upload/route.ts` | 文件上传与解析API |
| `/src/app/api/analyze/route.ts` | 分析任务创建与状态查询API |
| `/src/app/api/report/route.ts` | 报告生成与下载API |
| `/src/lib/parser/excel.ts` | Excel文件解析器 |
| `/src/lib/parser/csv.ts` | CSV文件解析器 |
| `/src/lib/parser/validator.ts` | 数据验证器 |
| `/src/lib/calculation-engine.ts` | 数据计算引擎（P90/MAD/阈值） |
| `/src/lib/chart-generator.ts` | 图表生成器（PNG） |
| `/src/lib/ai-service/factory.ts` | AI服务工厂（多供应商切换） |
| `/src/lib/ai-service/openai.ts` | OpenAI适配器 |
| `/src/lib/ai-service/claude.ts` | Claude适配器 |
| `/src/lib/report-generator/word.ts` | Word文档生成器 |
| `/src/lib/report-generator/excel.ts` | Excel文件生成器 |
| `/src/lib/config/prompts/` | Prompt模板目录 |
| `/prisma/schema.prisma` | 数据库模型定义 |

### 8.2 前端核心文件

| 文件路径 | 功能描述 |
|----------|----------|
| `/src/app/page.tsx` | 首页（上传入口） |
| `/src/app/analyze/[taskId]/page.tsx` | 分析进度页面 |
| `/src/app/report/[reportId]/page.tsx` | 报告预览页面 |
| `/src/components/upload/FileUploader.tsx` | 文件上传组件 |
| `/src/components/analyze/ProgressBar.tsx` | 进度条组件 |
| `/src/components/report/ReportViewer.tsx` | 报告查看器 |
| `/src/components/report/ChartDisplay.tsx` | 图表展示组件 |
| `/src/hooks/useUpload.ts` | 上传Hook |
| `/src/hooks/useAnalysis.ts` | 分析任务Hook |
| `/src/hooks/usePolling.ts` | 轮询Hook |

---

## 九、实施计划

### 9.1 MVP阶段（2-3周）

**Week 1：基础架构**
- 项目初始化（Next.js + TypeScript + TailwindCSS）
- 数据库设计与迁移
- 文件上传功能
- Excel/CSV解析器

**Week 2：核心功能**
- 数据计算引擎（P90/MAD/阈值）
- AI服务集成（OpenAI/Claude）
- 图表生成（PNG）
- 基础报告生成

**Week 3：完善与部署**
- 报告导出（Word/Excel）
- 前端UI优化
- 部署到Vercel
- 测试与修复

### 9.2 完整版阶段（4-6周）

- 用户认证系统
- 账号管理与历史记录
- 多AI供应商切换
- 高级图表与可视化
- 性能优化

### 9.3 扩展阶段（持续）

- Coze工作流集成
- 多账号对比分析
- 团队协作功能
- 移动端适配

---

## 十、非功能性需求

### 10.1 性能要求
- 文件上传：支持最大10MB文件
- 分析时间：单次分析不超过3分钟
- 并发支持：支持10个并发分析任务
- 响应时间：API响应 < 500ms

### 10.2 安全要求
- 数据传输：HTTPS加密
- 数据存储：敏感信息加密
- 访问控制：用户隔离
- 文件安全：上传文件类型和大小限制

### 10.3 可用性要求
- 系统可用性：99%以上
- 错误处理：友好的错误提示
- 进度反馈：实时展示分析进度

---

## 十一、成本估算

### 11.1 开发成本（MVP）

| 项目 | 时间 | 成本 |
|------|------|------|
| 前端开发 | 2周 | ¥20,000 |
| 后端开发 | 2周 | ¥20,000 |
| 测试 | 0.5周 | ¥5,000 |
| **总计** | | **¥45,000** |

### 11.2 运营成本（月度，MVP阶段）

| 项目 | 月成本 |
|------|--------|
| Vercel Pro | ¥140 |
| Vercel Blob (500GB) | ¥50 |
| OpenAI API (100万tokens) | ¥100 |
| Neon数据库 | ¥0（免费额度） |
| **总计** | **¥290/月** |

### 11.3 成本优化建议

1. **AI成本优化**：
   - 简单任务用GPT-4o-mini
   - 缓存重复分析结果
   - 批量处理请求

2. **存储成本优化**：
   - 定期清理过期文件（7天）
   - 压缩图片和文件

---

## 十二、风险与挑战

### 12.1 技术风险

| 风险 | 缓解措施 |
|------|----------|
| AI服务不稳定 | 多供应商切换、重试机制 |
| 文件解析失败 | 严格验证、友好错误提示 |
| 计算结果错误 | 单元测试、人工抽样验证 |
| Serverless超时 | 长任务拆分、使用Railway |

### 12.2 业务风险

| 风险 | 缓解措施 |
|------|----------|
| AI成本过高 | 使用缓存、优化Prompt |
| 数据质量问题 | 数据验证、用户确认步骤 |
| 用户需求变化 | 快速迭代、用户反馈 |

---

## 十三、验收标准

### 13.1 MVP验收标准

1. **文件上传**：成功上传Excel/CSV，正确解析数据
2. **数据计算**：P90、MAD、阈值计算准确
3. **AI分析**：生成账号概况、阶段划分、爆款分析
4. **图表生成**：正确生成PNG格式的趋势图和爆点图
5. **报告导出**：成功生成Word和Excel文件
6. **在线预览**：在网页上正确展示报告内容
7. **部署上线**：成功部署到Vercel，可正常访问

### 13.2 测试用例

| 测试场景 | 预期结果 |
|----------|----------|
| 上传10MB Excel文件 | 成功解析，显示预览 |
| 上传格式错误的文件 | 友好错误提示 |
| 缺少必要列的数据 | 提示缺失列，建议补充 |
| 分析1000条视频数据 | 3分钟内完成 |
| 生成Word报告 | 包含所有章节和图表 |
| 下载Excel源文件 | 多Sheet结构正确 |

---

## 十四、后续优化方向

1. **数据源扩展**：
   - 接入Coze工作流
   - 对接第三方数据平台API（蝉妈妈、新抖等）

2. **功能增强**：
   - 多账号对比分析
   - 竞品分析功能
   - 自定义分析维度

3. **体验优化**：
   - 实时进度推送（WebSocket）
   - 移动端适配
   - 深色模式

4. **商业化准备**：
   - 用户订阅系统
   - 使用量配额管理
   - 团队协作功能

---

## 附录：Prompt文件映射

| Prompt文件 | 对应功能模块 | 实现方式 |
|------------|-------------|----------|
| 01_规则.md | 全局规则和计算口径 | 代码固化 |
| 02_账号概况.md | 账号概况分析 | AI生成 |
| 03_月度平均综合表现趋势拆解.md | 月度趋势分析 | 代码计算 + AI分析阶段 |
| 04_全周期每日爆款视频拆解.md | 爆款分析 | 代码计算阈值 + AI抽象机制 |
| 05_30条可直接拍的爆款选题库.md | 选题库生成 | AI生成 |
| 06_生成word文档.md | Word报告生成 | 代码生成文档 |
