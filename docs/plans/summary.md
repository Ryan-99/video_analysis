# 问题修复方案 - 执行摘要

> 创建日期: 2025-01-22
> 状态: 方案设计完成，待实施

## 问题概述

本方案旨在解决抖音账号分析产品的三个关键问题：

1. **选题库生成失败** - Headers Timeout Error
2. **Word文档缺少图表** - 需要嵌入可视化图表
3. **导航体验不完善** - 缺少返回主页按钮

---

## 问题1: 选题库生成超时失败

### 根本原因
- 当前实现一次性生成30条完整选题（包含标题、口播稿、分镜等）
- 估计输出Token: 30 × 300 = 9000+ tokens
- 加上Prompt本身，总Token可能超过16000限制
- 长时间网络请求容易中断

### 解决方案：两阶段分批生成

```
阶段1: 生成选题大纲
├── 输入: 账号信息、爆款分析
├── 输出: 30条选题的 id, category, titles(3个)
├── 预计Token: ~2000-3000
└── 新Prompt: topic_outline_generation

阶段2: 分批生成完整内容
├── 分3批，每批10条
├── 每批生成: script, storyboard, casePoint
├── 预计Token/批: ~3000-4000
└── 总计: ~9000-12000 tokens（分散在3个请求中）
```

### 实施步骤
1. 在 `src/config/prompts.json` 添加 `topic_outline_generation` 模板
2. 在 `src/lib/ai-analysis/service.ts` 添加新方法：
   - `generateTopicsWithBatches()` - 主入口
   - `generateTopicOutline()` - 生成大纲
   - `generateTopicBatch()` - 分批生成完整内容
3. 更新调用流程使用新方法

### 预期效果
- 单次请求Token数降低 70%
- 超时风险显著降低
- 失败时可重试单个批次，不影响已生成的部分

---

## 问题2: Word文档缺少图表

### 当前状态
- Word文档只包含文本（账号概况、趋势数据、爆款分析、选题库）
- 已有图表生成服务：`src/lib/charts/service.ts`（QuickChart API）
- 但图表未嵌入Word文档

### 解决方案：图表嵌入Word

```
流程:
1. 生成图表配置 → ChartConfig
2. 调用QuickChart API → 生成图片URL
3. 下载图片 → Buffer
4. 使用docx的ImageRun → 嵌入Word
```

### 需要添加的图表
1. **月度趋势折线图** - 插入到"月度趋势分析"章节
2. **全周期每日爆点折线图** - 插入到"爆款视频分析"章节
3. **爆款分类柱状图** - 插入到"爆款视频分析"章节

### 实施步骤
1. 修改 `src/lib/report/word.ts`:
   - 导入 `ImageRun` from 'docx'
   - 修改函数签名接收 `chartBuffer` 参数
   - 在合适位置插入图表
   - 添加 `generateAndDownloadChart()` 辅助函数
2. 修改 `generateWordReport()` 生成并传入图表Buffer

### 预期效果
- Word文档包含完整的可视化图表
- 图表位置合理，与文本内容呼应
- 提升报告专业度和可读性

---

## 问题3: 添加返回主页按钮

### 当前状态
- **分析页面**: 仅在失败时显示返回按钮
- **报告页面**: 无返回按钮
- 用户体验不完善

### 解决方案：统一返回按钮组件

创建可复用的 `BackButton` 组件：
- 位置: `src/components/ui/BackButton.tsx`
- 样式: 与现有失败按钮一致
- 交互: 点击返回首页 (`router.push('/')`)

### 实施步骤
1. 创建 `BackButton` 组件
2. 在分析页面添加到header（始终显示）
3. 在报告页面添加到header
4. 确保样式和交互一致

### 设计规格
```typescript
<BackButton label="返回首页" />
// 样式: bg-white/5 border border-white/10
// 图标: 左箭头
// 位置: header左侧
// 响应式: 移动端可只显示图标
```

### 预期效果
- 用户可以随时返回主页
- 统一的导航体验
- 提升产品易用性

---

## 实施优先级

### 高优先级（快速解决）
1. **问题3: 返回按钮** - 实施简单，立即改善用户体验
   - 预计工作量: 30分钟

### 中优先级（核心功能）
2. **问题2: Word图表** - 提升报告完整性
   - 预计工作量: 1-2小时

3. **问题1: 选题库分批** - 解决稳定性问题
   - 预计工作量: 2-3小时
   - 需要测试验证

---

## 风险与注意事项

### 选题库分批生成
- **风险**: Prompt变化可能影响AI输出质量
- **缓解**: 保留原有Prompt作为备份，逐步切换
- **测试**: 需要完整测试30条选题的生成和合并

### Word图表嵌入
- **风险**: 图片下载可能失败
- **缓解**: 添加错误处理，图片失败时仍生成文本报告
- **测试**: 验证不同图表类型的嵌入效果

### 返回按钮
- **风险**: 较低，简单的UI组件
- **测试**: 确认在不同页面状态下的表现

---

## 文档位置

详细的实现方案已保存在：
- **任务计划**: `docs/plans/task_plan.md`
- **研究发现**: `docs/plans/findings.md`
- **进度日志**: `docs/plans/progress.md`
- **执行摘要**: `docs/plans/summary.md`（本文件）

---

## 下一步行动

1. **用户确认** - 审阅方案，确认实施优先级
2. **开始实施** - 按优先级逐个解决问题
3. **测试验证** - 完整测试每个修复
4. **文档更新** - 更新相关技术文档

---

*本方案遵循 planning-with-files 方法论，使用持久化文件存储所有关键信息。*
