# 问题修复计划

## 目标
修复三个关键问题，提升抖音账号分析产品的稳定性和用户体验：
1. 解决选题库生成超时失败问题
2. 将生成的图表图片添加到Word文档
3. 在各个页面添加返回主页按钮

## 当前阶段
Phase 1

## 阶段划分

### Phase 1: 需求分析与技术调研
- [x] 分析选题库生成失败的根本原因
- [x] 研究图表生成和Word嵌入的技术方案
- [x] 设计返回主页按钮的UI交互
- [x] 记录研究发现到 findings.md
- **状态**: complete

### Phase 2: 选题库生成拆分方案
- [ ] 设计选题库生成的两阶段方案（大纲+分批）
- [ ] 修改 AI prompt 配置
- [ ] 更新 ai-analysis/service.ts 实现分批调用
- [ ] 实现选题结果合并逻辑
- **状态**: pending

### Phase 3: 图表图片集成到Word
- [ ] 研究如何在Word中嵌入Base64图片
- [ ] 修改图表生成流程，保存图片到内存/临时文件
- [ ] 更新 word.ts 的报告生成逻辑
- [ ] 添加图表到Word文档的合适位置
- **状态**: pending

### Phase 4: 添加返回主页按钮
- [ ] 分析当前页面布局和导航结构
- [ ] 设计统一的返回按钮组件
- [ ] 在分析页面添加返回按钮
- [ ] 在报告页面添加返回按钮
- [ ] 确保样式一致性和用户体验
- **状态**: pending

### Phase 5: 测试与验证
- [ ] 测试选题库分批生成功能
- [ ] 验证Word文档中图表正确显示
- [ ] 测试返回按钮在各个页面的功能
- [ ] 记录测试结果到 progress.md
- **状态**: pending

### Phase 6: 文档更新与交付
- [ ] 更新相关技术文档
- [ ] 记录关键决策和经验教训
- [ ] 交付完整的修复方案
- **状态**: pending

## 关键问题

### 问题1: 选题库生成失败
- **错误**: Headers Timeout Error (UND_ERR_HEADERS_TIMEOUT)
- **根本原因**: 单次AI请求太大，生成30条完整选题超时（需要更长时间和更多token）
- **用户建议**: 拆解成多次生成
  1. 先基于账号内容规划30条选题大纲
  2. 然后分三次生成（每次10条）
- **当前配置**: 10分钟超时，16000 tokens
- **需要确认**: AI API的实际超时限制和token限制

### 问题2: Word中没有图片
- **现状**: word.ts 只生成文本内容，没有图表
- **已有资源**:
  - `src/lib/charts/service.ts`: 图表配置服务（使用QuickChart API）
  - `scripts/generate_charts.py`: Python图表生成脚本
- **技术挑战**: docx库如何嵌入图片（Base64 vs 文件路径）
- **需要设计**: 图表生成时机（分析时生成 vs 下载时生成）

### 问题3: 返回主页按钮
- **分析页面**: `src/app/analyze/[taskId]/page.tsx` - 已有失败时的返回按钮
- **报告页面**: 需要确认路径和实现
- **需求**: 在每个页面添加固定位置的返回按钮
- **设计考虑**: 按钮位置、样式、交互状态

## 技术决策

| 决策 | 理由 |
|------|------|
| 拆分选题库生成为2步 | 减少单次请求大小，避免超时 |
| 使用QuickChart API生成图表URL | 无需Python依赖，简化部署 |
| docx使用ImageRun嵌入图片 | 支持Base64和Buffer，灵活性高 |
| 创建通用BackButton组件 | 保持UI一致性，便于维护 |

## 遇到的错误

| 错误 | 尝试 | 解决方案 |
|------|------|----------|
| - | 1 | - |

## 注意事项
- 更新阶段状态：pending → in_progress → complete
- 在重大决策前重新阅读本计划（注意力管理）
- 记录所有错误 - 它们有助于避免重复
- 永远不要重复失败的行动 - 改变方法代替
