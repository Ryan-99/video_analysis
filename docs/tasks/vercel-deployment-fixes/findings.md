# 研究发现

**更新时间**: 2025-01-24

---

## Vercel Serverless 限制

### 1. 执行环境冻结
- HTTP 响应返回后，执行环境会被冻结
- 未完成的 Promise 会被丢弃
- **解决方案**: 必须同步等待任务完成

### 2. 内存状态不共享
- 不同请求可能在不同的容器中执行
- 内存 Map/Set 无法在请求间共享
- **解决方案**: 使用数据库存储状态

### 3. 文件系统限制
- `/tmp` 目录可写，但重启后清空
- `/public` 目录只读
- **解决方案**: 使用 Vercel Blob 存储文件

---

## 已知问题

### 日志系统
**问题**: `AnalysisLogger` 使用内存 Map 存储
**影响**: 前台无法拉取日志
**修复**: 需要改为数据库存储

### 选题生成
**问题**: 每批超时 60 秒可能不够
**影响**: 选题生成可能超时失败
**修复**: 增加到 300 秒，同时增加整体超时

### NetworkError (新发现)
**根本原因**: 前端调用 `fetch('/api/jobs/process')` 后立即 `router.push()` 跳转页面
**结果**: 浏览器取消正在进行的 fetch 请求，导致 NetworkError
**解决方案**: 使用 `fetch` 的 `keepalive: true` 选项，或改用 `navigator.sendBeacon()`

---

## 架构决策

### 任务执行模式
**当前**: 前端调用 `/api/jobs/process` 触发任务
**问题**: 前端请求可能超时
**建议**: 改用 Vercel Cron Jobs 定期轮询队列
