# 任务计划：修复AI响应JSON中未转义引号的解析问题

**创建时间：** 2026-01-31
**任务状态：** in_progress

## 问题描述

AI返回的JSON响应中包含未转义的中文引号（如 `"爆到天上"`），导致JSON解析失败。

### 错误信息
```
Expected ',' or '}' after property value in JSON at position 729 (line 3 column 674)
```

### 问题根因分析

根据日志分析：
- AI返回文本：`即使有一条数据"爆到天上",对MAD值的影响也有限`
- 位置728的引号：被正确识别为内部引号，转义为 `\"`
- **位置733的引号**：被**错误**识别为"强结束标记"（因为下一个字符是逗号`,`），未转义

代码中的问题（第268-276行）：
```typescript
// 规则1：强结束标记（最高优先级）
const isStrongEndMarker =
  nextChar === ',' || nextChar === '}' || nextChar === ']' ||
  nextChar === '' || nextChar === ':';

if (isStrongEndMarker) {
  inString = false;
  result.push(c);
  console.log(`[fixUnescapedQuotes] 位置 ${i}: 强结束标记 (后跟: '${nextChar}')`);
  continue;
}
```

**问题所在**：当引号后紧跟逗号时，代码假设这是字符串结束标记。但在中文文本中，引号常用于引用，后面可以跟逗号。如：
- `即使有一条数据"爆到天上",对MAD值的影响也有限` - 这里位置733的引号后面是逗号，但它是**内部引号**，不应该作为字符串结束。

---

## 阶段规划

### 阶段1：代码定位与分析 ✅
- [x] 找到 `safeParseJSON` 函数（service.ts:135-627）
- [x] 找到 `fixUnescapedQuotes` 逻辑（service.ts:174-345）
- [x] 找到 `cleanAIResponse` 函数（service.ts:15-129）
- [x] 分析引号处理逻辑的缺陷

### 阶段2：修复方案设计
- [x] 理解"强结束标记"判定逻辑
- [x] 分析为何位置733的引号被错误判定
- [x] 设计修复方案

### 阶段3：实施修复
- [ ] 修复引号识别和转义逻辑
- [ ] 减少过多的日志输出
- [ ] 测试修复效果

### 阶段4：验证
- [ ] 运行测试验证修复
- [ ] 更新项目反思记录

---

## 修复方案

### 方案：改进引号识别逻辑

当前逻辑问题：
- 仅基于**下一个字符**判断是否为字符串结束
- 没有检查**前后上下文**来验证这是否真的是字符串结束

修复策略：
1. **向后检查**：当发现引号后是结束标记时，继续向后检查，看是否还有未关闭的引号
2. **平衡检测**：确保从当前位置到字符串结束标记之间，引号是成对的
3. **日志优化**：减少过多的位置日志，只在修复完成后输出摘要

---

## 相关文件

- [src/lib/ai-analysis/service.ts](src/lib/ai-analysis/service.ts) - 主要修复文件
  - `cleanAIResponse` 函数（第15-129行）
  - `safeParseJSON` 函数中的 `fixUnescapedQuotes` 逻辑（第174-345行）

---

*最后更新：2026-01-31*
